# Source and Concept Vocabularies – Output Generation

Using the tabular output generated by `scv_process`, this function will
build a graph to visualize the results. Each function configuration will
output a bespoke ggplot. Theming can be adjusted by the user after the
graph has been output using `+ theme()`. Most graphs can also be made
interactive using `make_interactive_squba()`

## Usage

``` r
scv_output(
  process_output,
  code_type,
  filter_concept = NULL,
  filter_mapped = NULL,
  num_codes = 10,
  num_mappings = 25,
  vocab_tbl = NULL,
  large_n = FALSE,
  large_n_sites = NULL
)
```

## Arguments

- process_output:

  *tabular input* \|\| **required**

  The tabular output produced by `scv_process`

- code_type:

  *string* \|\| **required**

  A string identifying the type of concept that was been provided in the
  `concept_set`. This should match whatever was provided when executing
  the `scv_process` function.

  Acceptable values are `cdm` (the standard, mapped code that is
  included in the CDM) or `source` (the "raw" concept from the source
  system)

- filter_concept:

  *(integer or string) or vector* \|\| defaults to `NULL`

  An integer/string (depending on the data model) or vector of concepts
  (as provided in the `concept_set` in `scv_process`) that should appear
  in the output. This parameter is required for the following check
  types:

  - `Single Site, Anomaly Detection, Cross-Sectional`

  - `Multi-Site, Anomaly Detection, Cross-Sectional`

  - `Multi-Site, Exploratory, Longitudinal`

  - `Single Site, Anomaly Detection, Longitudinal`

  - `Multi-Site, Anomaly Detection, Longitudinal`

- filter_mapped:

  *integer or string* \|\| defaults to `NULL`

  An integer/string (depending on the data model) representing a mapping
  associated with `filter_concept`, as it appears in the output. This
  parameter is required for the following check types:

  - `Multi-Site, Anomaly Detection, Longitudinal`

- num_codes:

  *integer* \|\| defaults to `10`

  An integer indicating the top N of concepts (of `code_type`) that
  should be displayed in the plot. This parameter is required for the
  following check types:

  - `Single Site, Exploratory, Cross-Sectional`

  - `Multi-Site, Exploratory, Cross-Sectional`

  - `Single Site, Anomaly Detection, Cross-Sectional`

- num_mappings:

  *integer* \|\| defaults to `25`

  An integer indicating the top N of mappings associated with each
  concept of `code_type` that should be displayed on the plot. This
  parameter is required for the following check types:

  - `Single Site, Exploratory, Cross-Sectional`

  - `Single Site, Anomaly Detection, Cross-Sectional`

  - `Multi-Site, Anomaly Detection, Cross-Sectional`

  - `Single Site, Exploratory, Longitudinal`

  - `Multi-Site, Exploratory, Longitudinal`

  - `Multi-Site, Anomaly Detection, Longitudinal`

- vocab_tbl:

  *tabular input* \|\| **optional**

  A vocabulary table containing concept names for the provided codes
  (ex: the OMOP concept table)

- large_n:

  *boolean* \|\| defaults to `FALSE`

  For Multi-Site analyses, a boolean indicating whether the large N
  visualization, intended for a high volume of sites, should be used.
  This visualization will produce high level summaries across all sites,
  with an option to add specific site comparators via the
  `large_n_sites` parameter.

- large_n_sites:

  *vector* \|\| defaults to `NULL`

  When `large_n = TRUE`, a vector of site names that can add site-level
  information to the plot for comparison across the high level summary
  information.

## Value

This function will produce a graph to visualize the results from
`scv_process` based on the parameters provided. The default output is
typically a static ggplot or gt object, but interactive elements can be
activated by passing the plot through `make_interactive_squba`. For a
more detailed description of output specific to each check type, see the
PEDSpace metadata repository

## Examples

``` r
#' Source setup file
source(system.file('setup.R', package = 'sourceconceptvocabularies'))

#' Create in-memory RSQLite database using data in extdata directory
conn <- mk_testdb_omop()

#' Establish connection to database and generate internal configurations
initialize_dq_session(session_name = 'scv_process_test',
                      working_directory = my_directory,
                      db_conn = conn,
                      is_json = FALSE,
                      file_subdirectory = my_file_folder,
                      cdm_schema = NA)
#> Connected to: :memory:@NA

#' Build mock study cohort
cohort <- cdm_tbl('person') %>% dplyr::distinct(person_id) %>%
  dplyr::mutate(start_date = as.Date(-5000),
                #RSQLite does not store date objects,
                #hence the numerics
                end_date = as.Date(15000),
                site = ifelse(person_id %in% c(1:6), 'synth1', 'synth2'))

#' Prepare input tables
scv_domain_tbl <- dplyr::tibble(domain = 'condition_occurrence',
                                concept_field = 'condition_concept_id',
                                source_concept_field =
                                  'condition_source_concept_id',
                                date_field = 'condition_start_date',
                                vocabulary_field = NA)

scv_concept_set <- read_codeset('dx_hypertension')

#' Execute `scv_process` function
#' This example will use the single site, exploratory, cross sectional
#' configuration
scv_process_example <- scv_process(cohort = cohort,
                                   multi_or_single_site = 'single',
                                   anomaly_or_exploratory = 'exploratory',
                                   time = FALSE,
                                   omop_or_pcornet = 'omop',
                                   code_type = 'cdm',
                                   code_domain = 'condition_occurrence',
                                   domain_tbl = scv_domain_tbl,
                                   concept_set = scv_concept_set) %>%
  suppressMessages()
#> ┌ Output Function Details ──────────────────────────────────────┐
#> │ You can optionally use this dataframe in the accompanying     │
#> │ `scv_output` function. Here are the parameters you will need: │
#> │                                                               │
#> │ Always Required: process_output, code_type                    │
#> │ Required for Check: num_codes, num_mappings                   │
#> │ Optional: vocab_tbl                                           │
#> │                                                               │
#> │ See ?scv_output for more details.                             │
#> └───────────────────────────────────────────────────────────────┘

scv_process_example
#> # A tibble: 1 × 10
#>   site     domain            concept_id source_concept_id    ct denom_concept_ct
#>   <chr>    <chr>                  <int>             <int> <int>            <int>
#> 1 combined condition_occurr…     320128            320128     5                5
#> # ℹ 4 more variables: denom_source_ct <int>, concept_prop <dbl>,
#> #   source_prop <dbl>, output_function <chr>

#' Execute `scv_output` function
scv_output_example <- scv_output(process_output = scv_process_example,
                                 code_type = 'cdm',
                                 vocab_tbl = NULL) %>%
  suppressMessages()

scv_output_example[[1]]


#' Easily convert the graph into an interactive ggiraph or plotly object with
#' `make_interactive_squba()`

make_interactive_squba(scv_output_example[[1]])

{"x":{"html":"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' class='ggiraph-svg' role='graphics-document' id='svg_d11fc4360aa02306' viewBox='0 0 432 360'>\n <defs id='svg_d11fc4360aa02306_defs'>\n  <clipPath id='svg_d11fc4360aa02306_c1'>\n   <rect x='0' y='0' width='432' height='360'/>\n  <\/clipPath>\n  <clipPath id='svg_d11fc4360aa02306_c2'>\n   <rect x='49.01' y='44.36' width='294.78' height='298.99'/>\n  <\/clipPath>\n  <clipPath id='svg_d11fc4360aa02306_c3'>\n   <rect x='49.01' y='21.08' width='294.78' height='23.28'/>\n  <\/clipPath>\n <\/defs>\n <g id='svg_d11fc4360aa02306_rootg' class='ggiraph-svg-rootg'>\n  <g clip-path='url(#svg_d11fc4360aa02306_c1)'>\n   <rect x='0' y='0' width='432' height='360' fill='#FFFFFF' fill-opacity='1' stroke='#FFFFFF' stroke-opacity='1' stroke-width='0.75' stroke-linejoin='round' stroke-linecap='round' class='ggiraph-svg-bg'/>\n   <rect x='0' y='0' width='432' height='360' fill='#FFFFFF' fill-opacity='1' stroke='none'/>\n  <\/g>\n  <g clip-path='url(#svg_d11fc4360aa02306_c2)'>\n   <polyline points='49.01,193.86 343.79,193.86' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='196.40,343.35 196.40,44.36' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <rect id='svg_d11fc4360aa02306_e1' x='73.58' y='69.28' width='245.65' height='249.15' fill='#FBB761' fill-opacity='1' stroke='none' title='Mapped Concept Name: No vocabulary table input'/>\n   <text x='193.69' y='196.97' font-size='6.4pt' font-family='DejaVu Sans'>1<\/text>\n  <\/g>\n  <g clip-path='url(#svg_d11fc4360aa02306_c3)'>\n   <text x='182.69' y='31.46' font-size='5.4pt' font-family='DejaVu Sans' fill='#1A1A1A' fill-opacity='1'>320128<\/text>\n   <text x='163.79' y='39.23' font-size='5.4pt' font-family='DejaVu Sans' fill='#1A1A1A' fill-opacity='1'> Total Mappings: 1<\/text>\n  <\/g>\n  <g clip-path='url(#svg_d11fc4360aa02306_c1)'>\n   <text x='16.65' y='196.48' font-size='5.4pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>320128<\/text>\n   <text x='172.11' y='352.65' font-size='6.75pt' font-family='DejaVu Sans'>concept_id<\/text>\n   <text transform='translate(12.04,235.34) rotate(-90.00)' font-size='6.75pt' font-family='DejaVu Sans'>source_concept_id<\/text>\n   <text x='360.23' y='151.2' font-size='6.75pt' font-family='DejaVu Sans'>concept_prop<\/text>\n   <image x='360.23' y='157.61' width='17.28' height='86.4' preserveAspectRatio='none' xlink:href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAEsCAYAAAACUNnVAAAAHUlEQVQ4jWP4vT3xPxMDAwPDKDFKjBKjxCgxXAgA1SgFadr2HN0AAAAASUVORK5CYII=' xmlns:xlink='http://www.w3.org/1999/xlink'/>\n   <polyline points='374.05,200.81 377.51,200.81' fill='none' stroke='#FFFFFF' stroke-opacity='1' stroke-width='0.37' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='363.69,200.81 360.23,200.81' fill='none' stroke='#FFFFFF' stroke-opacity='1' stroke-width='0.37' stroke-linejoin='round' stroke-linecap='butt'/>\n   <text x='382.99' y='203.43' font-size='5.4pt' font-family='DejaVu Sans'>1<\/text>\n   <text x='49.01' y='13.36' font-size='8.1pt' font-family='DejaVu Sans'>Top 25 Mappings for Top 10 CDM Codes<\/text>\n  <\/g>\n <\/g>\n<\/svg>","js":null,"uid":"svg_d11fc4360aa02306","ratio":1.2,"settings":{"tooltip":{"css":".tooltip_SVGID_ { padding:5px;background:black;color:white;border-radius:2px;text-align:left; ; position:absolute;pointer-events:none;z-index:999;}","placement":"doc","opacity":0.9,"offx":10,"offy":10,"use_cursor_pos":true,"use_fill":false,"use_stroke":false,"delay_over":200,"delay_out":500},"hover":{"css":".hover_data_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_data_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_data_SVGID_ { fill:orange;stroke:black; }\nline.hover_data_SVGID_, polyline.hover_data_SVGID_ { fill:none;stroke:orange; }\nrect.hover_data_SVGID_, polygon.hover_data_SVGID_, path.hover_data_SVGID_ { fill:orange;stroke:none; }\nimage.hover_data_SVGID_ { stroke:orange; }","reactive":true,"nearest_distance":null},"hover_inv":{"css":""},"hover_key":{"css":".hover_key_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_key_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_key_SVGID_ { fill:orange;stroke:black; }\nline.hover_key_SVGID_, polyline.hover_key_SVGID_ { fill:none;stroke:orange; }\nrect.hover_key_SVGID_, polygon.hover_key_SVGID_, path.hover_key_SVGID_ { fill:orange;stroke:none; }\nimage.hover_key_SVGID_ { stroke:orange; }","reactive":true},"hover_theme":{"css":".hover_theme_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_theme_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_theme_SVGID_ { fill:orange;stroke:black; }\nline.hover_theme_SVGID_, polyline.hover_theme_SVGID_ { fill:none;stroke:orange; }\nrect.hover_theme_SVGID_, polygon.hover_theme_SVGID_, path.hover_theme_SVGID_ { fill:orange;stroke:none; }\nimage.hover_theme_SVGID_ { stroke:orange; }","reactive":true},"select":{"css":".select_data_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_data_SVGID_ { stroke:none;fill:red; }\ncircle.select_data_SVGID_ { fill:red;stroke:black; }\nline.select_data_SVGID_, polyline.select_data_SVGID_ { fill:none;stroke:red; }\nrect.select_data_SVGID_, polygon.select_data_SVGID_, path.select_data_SVGID_ { fill:red;stroke:none; }\nimage.select_data_SVGID_ { stroke:red; }","type":"multiple","only_shiny":true,"selected":[]},"select_inv":{"css":""},"select_key":{"css":".select_key_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_key_SVGID_ { stroke:none;fill:red; }\ncircle.select_key_SVGID_ { fill:red;stroke:black; }\nline.select_key_SVGID_, polyline.select_key_SVGID_ { fill:none;stroke:red; }\nrect.select_key_SVGID_, polygon.select_key_SVGID_, path.select_key_SVGID_ { fill:red;stroke:none; }\nimage.select_key_SVGID_ { stroke:red; }","type":"single","only_shiny":true,"selected":[]},"select_theme":{"css":".select_theme_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_theme_SVGID_ { stroke:none;fill:red; }\ncircle.select_theme_SVGID_ { fill:red;stroke:black; }\nline.select_theme_SVGID_, polyline.select_theme_SVGID_ { fill:none;stroke:red; }\nrect.select_theme_SVGID_, polygon.select_theme_SVGID_, path.select_theme_SVGID_ { fill:red;stroke:none; }\nimage.select_theme_SVGID_ { stroke:red; }","type":"single","only_shiny":true,"selected":[]},"zoom":{"min":1,"max":1,"duration":300,"default_on":false},"toolbar":{"position":"topright","pngname":"diagram","tooltips":null,"fixed":false,"hidden":[],"delay_over":200,"delay_out":500},"sizing":{"rescale":true,"width":1}}},"evals":[],"jsHooks":[]}
```
